# Epic 3 Retrospective — Agent Conversation Experience

**Date:** 2026-02-04
**Facilitator:** Bob (Scrum Master)
**Participants:** Alice (Product Owner), Bob (SM), Charlie (Senior Dev), Dana (QA Engineer), Elena (Junior Dev), Flow (Project Lead)

---

## Epic Summary

| Metric | Value |
| --- | --- |
| Epic | 3 — Agent Conversation Experience |
| Stories Completed | 11/11 (100%) |
| Stories Planned (Epic 2 Retro) | 6 (grew to 11) |
| FRs Covered | FR9, FR10, FR11, FR13, FR14, FR15, FR16, FR18, FR19, FR20, FR21, FR22 |
| Tests (start → end) | 213 → ~468 (272 new, zero regressions) |
| Code Review Findings | ~10 CRITICAL, ~7 HIGH, ~24 MEDIUM, ~20 LOW |
| All CRITICAL/HIGH Resolved | Yes |
| Production Incidents | 0 (not yet deployed) |
| Agent Model | Claude Opus 4.5 (all stories) |
| Code Reviewers | Opus + Gemini (3.1-3.3), single-model (3.4-3.11) |
| New npm Dependencies | 3 (marked, dompurify, highlight.js — Story 3.5 only) |

## Stories Delivered

| Story | Title | Highlights |
| --- | --- | --- |
| 3-1 | WebSocket Connection & Streaming | Foundation story. Bidirectional WS pipeline, shared `/ws` with `chat:` namespace. 16 files, 7 CRITICAL bugs caught in review. 38 new tests. |
| 3-2 | Chat Service & Message Sending | First chat UI components. SignalWatcher(LitElement) pattern established. Esbuild tree-shaking fix discovered. 33 new tests. |
| 3-3 | Agent Selection & Parallel Conversations | Agent dropdown, parallel ephemeral conversations. Clean implementation. 39 new tests. |
| 3-4 | Chat Panel & Conversation Blocks | Enhancement story — copy-on-hover, scroll-to-bottom, `repeat()` directive for perf. 14 new tests. |
| 3-5 | Markdown Renderer | Shared component (reused in 3.6, 3.10). Only story adding npm deps. 12 new tests. |
| 3-6 | Thinking Content Display | Minimal story — 2 files modified. All backend plumbing pre-existed. 8 new tests. |
| 3-7 | Context Indicator | Token usage progress bar. MODEL_CONTEXT_WINDOWS static map. Dumb component pattern. 17 new tests. |
| 3-8 | Text Highlighting | Selection API + `<mark>` overlays. CSS Custom Highlight API deferred. 17 new tests. |
| 3-9 | Conversation Lifecycle | Largest scope — 12+ new files, full-stack. Stub Insight pipeline. camelCase/snake_case bug. 31 new tests. |
| 3-10 | Insight Library | Full CRUD backend. Router migration. 40 new tests. |
| 3-11 | Attach Context & Insight Injection | Context picker with Insights, file browser, uploads. Invisible context messages. 23 new tests. |

## Successes

1. **100% story completion with scope expansion** — Delivered 11 stories vs 6 planned, 100% completion
2. **epic-supervisor automation** — Flow built automation workflows by Story 4, enabling 6 fully tested stories in ~90 minutes vs a full day manually. Biggest process innovation of the project.
3. **Pattern reuse as velocity multiplier** — SignalWatcher(LitElement) from 3.2, markdown renderer from 3.5, Insight pipeline from 3.9 — each built once, reused across multiple stories
4. **Test trajectory** — 213 → ~468, 272 new tests with zero regressions across all 11 stories
5. **Foundation story investment** — 3.1 (WebSocket) was hardest (7 CRITICAL), but enabled everything after
6. **Code-simplifier discipline** — Runs documented on 3.4, 3.5, 3.6, 3.8, 3.11, keeping codebase lean
7. **Strict dependency policy** — Only 3 new npm deps across 11 stories (all in 3.5)

## Challenges

1. **JSON casing mismatch (3 stories)** — camelCase vs snake_case hit in 3.1 (UsageStats), 3.9 (Insight interface), 3.10 (wire compatibility). Root cause: agent instructions enforce camelCase in frontend while Go backend uses snake_case JSON tags. Fix: update project-context.md to specify frontend mirrors backend wire format.
2. **Dual-model review dropped mid-epic** — Used for 3.1-3.3, dropped for 3.4-3.11. Automation velocity made it feel unnecessary. Stories 3.1-3.3 caught 10 CRITICAL + 7 HIGH; 3.4-3.11 had 0 CRITICAL, 0 HIGH — unclear if cleaner code or missed issues.
3. **Race conditions and async state** — Data race in 3.1 hub, goroutine leak in 3.1, focusout race in 3.3, orphaned conversation race in 3.3, context-full modal re-trigger in 3.9. Recurring pattern in async Go/JS boundaries.
4. **Render-time side effects in Lit** — SignalWatcher mutations during render in 3.2 and 3.3. Required moving logic to `willUpdate`/`updated` lifecycle.
5. **Accessibility implemented but caught in review** — Continuing pattern from Epic 2. ARIA attributes, prefers-reduced-motion, keyboard nav caught in review rather than initial implementation.
6. **Dead code accumulation** — Empty lifecycle overrides (3.2), dead CSS rules (3.3), unused imports (3.9). Code-simplifier catches these but shouldn't be needed.

## Key Insights

1. **Automation is the multiplier** — `epic-supervisor` turned a full day of work into 90 minutes for 6 stories. This is arguably Epic 3's biggest deliverable even though it's not in the story list.
2. **Agent instructions create conventions** — JSON casing mismatch is an instruction gap, not a code bug. Fixing the instruction prevents the entire category.
3. **Quality gates must scale with velocity** — When automation speeds delivery, review processes need to keep pace, not get dropped.
4. **Foundation stories pay compound interest** — 3.1's WebSocket pipeline and 3.2's SignalWatcher pattern enabled everything that followed.
5. **No real API testing yet** — The entire Epic 3 conversation pipeline has been tested against mocks only. Real API validation is a hard prerequisite before Epic 4.

## Code Review Pattern Analysis

| Category | Frequency | Examples |
| --- | --- | --- |
| JSON serialization mismatch | 3/11 stories | camelCase/snake_case (3.1, 3.9, 3.10) |
| Race conditions / async state | 3/11 stories | Data race (3.1), focusout race (3.3), modal re-trigger (3.9) |
| Render-time side effects | 2/11 stories | SignalWatcher mutations during render (3.2, 3.3) |
| Accessibility gaps | 4/11 stories | ARIA attributes (3.3), prefers-reduced-motion (3.3), a11y patterns (3.7, 3.8) |
| Dead code | 3/11 stories | Empty overrides (3.2), dead CSS (3.3), unused imports (3.9) |
| Unhandled promise rejection | 1/11 stories | Agent selection (3.3) |

## Previous Retrospective Follow-Through (Epic 2)

| # | Action | Status | Evidence |
| --- | --- | --- | --- |
| 1 | Continue dual-model parallel review | ⚠️ Partial | Used in 3.1, 3.2, 3.3 — dropped for 3.4-3.11 |
| 2 | Continue code-simplifier between stories | ✅ Completed | Documented runs on 3.4, 3.5, 3.6, 3.8, 3.11 |
| 3 | Fix story status inconsistencies | ✅ Completed | Sprint-status aligned |
| 6 | Auto-documentation on PR merges | ❌ Not Addressed | Two epics in backlog — decide: fold into automation or drop |
| 7 | Formalize code-simplifier as automated hook | ❌ Not Addressed | Two epics in backlog — decide: fold into automation or drop |

**Research Spikes from Epic 2 Retro:**

| # | Spike | Status |
| --- | --- | --- |
| 1 | Streaming conventions research | ✅ Applied — shared `/ws` with `chat:` namespace |
| 2 | Claude API access model | ✅ Applied — API key approach |
| 3 | Ollama integration test setup | ⏳ Unclear |

## Technical Debt

| # | Item | Priority | Source |
| --- | --- | --- | --- |
| 1 | Error detection via `content.startsWith('Error: ')` — needs dedicated error field | Medium | Story 3.2 |
| 2 | `MODEL_CONTEXT_WINDOWS` static map — needs update mechanism for new models | Medium | Story 3.7 |
| 3 | No file size limit on uploads (FileReader risk) | Medium | Story 3.11 |
| 4 | Approximate token cost heuristic (charCount/4) | Low | Story 3.11 |
| 5 | Hardcoded SVG icons (65 lines) in agent selector | Low | Story 3.3 |
| 6 | Lifecycle menu lacks click-outside dismiss | Low | Story 3.9 |
| 7 | `class` attribute allowed in DOMPurify (minor Shadow DOM scoping risk) | Low | Story 3.5 |
| 8 | Hardcoded `id="thinking-body"` (conflicts with virtual scrolling) | Low | Story 3.6 |

**Carried from Epic 2:** Items 1-6 from Epic 2 debt list (all Low, none blocking).

## Action Items

### Process Improvements

| # | Action | Owner | Success Criteria |
| --- | --- | --- | --- |
| 1 | Update project-context.md: frontend uses snake_case JSON to match backend wire format | Flow | Zero JSON casing bugs in Epic 4 |
| 2 | Restore dual-model review for Epic 4, integrate into epic-supervisor | Flow | Every story gets dual-model review |
| 3 | Enhance epic-supervisor with Epic 3 lessons | Flow | Automation handles review gates, convention enforcement |

### Carried Items (Two Epics — Decision Required)

| # | Item | Recommendation |
| --- | --- | --- |
| 4 | Auto-documentation on PR merges | Drop — retro process captures what matters |
| 5 | Formalize code-simplifier as automated hook | Fold into epic-supervisor enhancements |

## Epic 4 Preparation Tasks

### Critical (Must complete before Epic 4)

| # | Task | Owner |
| --- | --- | --- |
| 1 | **Real API integration testing** — local model + Kimi K2.5 against full Epic 3 pipeline | Flow |
| 2 | **Fix JSON serialization convention** in project-context.md / agent instructions | Flow |
| 3 | **Validate Insight pipeline end-to-end** — create, store, retrieve, inject with real data | Flow |

### Parallel (Can happen during early stories)

| # | Task | Owner |
| --- | --- | --- |
| 4 | Verify Epic 0 services under real integration (`/bmad/status`, `/artifacts`) | Flow |
| 5 | Update `MODEL_CONTEXT_WINDOWS` map for models being tested | Flow |

## Readiness Assessment

| Area | Status | Notes |
| --- | --- | --- |
| Testing & Quality | ⚠️ Partial | 468 tests passing, no real API integration test yet |
| Deployment | N/A | Desktop app, dev mode |
| Stakeholder Acceptance | ⚠️ Pending | Real API testing will serve as acceptance |
| Technical Health | ✅ Solid | Code-simplifier passes, clean architecture |
| Unresolved Blockers | ⚠️ One | Real API validation must pass before Epic 4 |

## Next Steps

1. **Real API integration testing** — local model + Kimi K2.5 (CRITICAL gate)
2. **Fix JSON serialization convention** in project-context.md
3. **Enhance epic-supervisor** with dual-model review and convention enforcement
4. **Begin Epic 4** when API testing passes — start with Story 4.1 (Context Injection)

## Team Performance

Epic 3 delivered 11 stories (up from 6 planned) with 100% completion. 272 new tests with zero regressions. The `epic-supervisor` automation reduced delivery of 6 stories from a full day to 90 minutes. The retrospective surfaced 4 key insights and 1 critical blocker (real API testing). The team is well-positioned for Epic 4 success once integration validation passes.

---

**Retrospective Status:** COMPLETE
**Document:** `_bmad-output/implementation-artifacts/epic-3-retro-2026-02-04.md`
